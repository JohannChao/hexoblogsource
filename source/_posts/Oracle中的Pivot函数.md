---
title: Oracle中的Pivot函数
tags: 
- java
- 数据库
- oracle
categories:
- 数据库
- oracle
date: 2019-09-20 15:15:41
comments: true
---
### Pivot函数

Pivot函数是在Oracle 数据库 11g 推出之后，新增的一个行数据转列数据的函数。

<!-- more -->

基础数据展示：

id | name |province_code | visit_times
---|--- | --- | ---
1  | ZhangZi  |  BJ   | 0 
1  | LiZhen  |  BJ   | 0
1  | LiuHong  |  BJ   | 1
1  | WangChao  |  SH   | 0
1  | QinNing  |  SH   | 1
1  | ZhaoYun  |  SH   | 2
1  | HongShen  |  SH   | 2
1  | MiFeng  |  HEB   | 0
1  | ChengKai  |  HEB   | 1
1  | ChenGuang  |  HEB   | 2

我们现在想知道，访问各个省市的次数的详情，即访问一次,两次，三次的各有多少人。

可以使用分组函数 count 得到这些数据

分组数据展示：

province_code | visit_times | count
---|--- | --- 
  BJ   | 0 | 2
  BJ   | 1 | 1
  SH   | 0 | 1
  SH   | 1 | 1
  SH   | 2 | 2
  HEB   | 0 | 1
  HEB   | 1 | 1
  HEB   | 2 | 1

但是，这样展示的话，数据不直观，我们想要得到下面这个样式的结果

visit_times | BJ | SH | HEB
---|--- | --- | --- 
 0  | 2 | 1 | 1
 1  | 1 | 1 | 1
 2  | 0 | 2 | 1 

在 Oracle 数据库 11g 推出之前，您需要针对每个值通过 decode 函数进行以上操作，并将每个不同的值编写为一个单独的列。但是，该方法一点也不直观。


### Demo详解

本文中使用的数据，在文章最后，如果需要直接复制使用即可。

执行分组SQL
```sql
select province_code, times_purchased, count(1) cnt
from JOHANN_PIVOT_TEST
group by province_code, times_purchased
ORDER BY province_code;
```
得到结果如下：
{% asset_img jieguo3.png 分组函数结果 %}
 
执行包含有Pivot的SQL
```sql
--注意：使用Pivot函数，你要知道自己需要哪些“列”，可通过上述的分组函数先找出来自己可能需要的“列”
 select * from (
   SELECT province_code, times_purchased 
	 FROM JOHANN_PIVOT_TEST
)
pivot 
(
   count(province_code)
   for province_code in ('BJ','TJ','HEB','SH','XZ')
)
order by times_purchased;
```
得到结果如下：
{% asset_img jieguo2.png Pivot函数结果 %}

如果想要以“访问次数”为列，则是需要把SQL做以下改动即可
```sql
select
*
from (
   SELECT province_code, times_purchased 
	 FROM JOHANN_PIVOT_TEST
)
pivot 
(
   count(times_purchased)
   for times_purchased in (0,1,2,3,4,5)
)
order by province_code;
```
得到结果如下：
{% asset_img jieguo3.png Pivot函数结果 %}

```
注意:在pivot函数中，只允许使用分组函数
Ø COUNT
Ø AVG
Ø SUM
Ø MAX
Ø MIN
```

### 基础数据

```
DROP TABLE "JOHANN_PIVOT_TEST";
CREATE TABLE "JOHANN_PIVOT_TEST" (
  "CUST_ID" NUMBER(10) NOT NULL ,
  "CUST_NAME" VARCHAR2(20 BYTE) ,
  "PROVINCE_CODE" VARCHAR2(3 BYTE) ,
  "TIMES_PURCHASED" NUMBER(3) 
);

INSERT ALL 
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (1,'temp','HEB',1)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (2,'temp','HEB',1)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (3,'temp','HEB',1)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (4,'temp','HEB',1)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (5,'temp','HEB',2)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (6,'temp','HEB',2)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (7,'temp','HEB',0)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (8,'temp','HEB',0)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (9,'temp','HEB',3)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (10,'temp','HEB',3)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (11,'temp','HEB',3)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (12,'temp','HEB',3)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (13,'temp','HEB',3)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (14,'temp','HEB',4)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (15,'temp','HEB',4)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (16,'temp','HEB',4)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (17,'temp','HEB',4)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (18,'temp','HEB',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (19,'temp','HEB',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (20,'temp','HEB',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (21,'temp','BJ',0)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (22,'temp','BJ',0)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (23,'temp','BJ',1)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (24,'temp','BJ',1)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (25,'temp','BJ',1)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (26,'temp','BJ',2)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (27,'temp','BJ',2)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (28,'temp','BJ',2)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (29,'temp','BJ',2)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (30,'temp','BJ',2)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (31,'temp','BJ',3)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (32,'temp','BJ',4)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (33,'temp','BJ',4)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (34,'temp','BJ',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (35,'temp','BJ',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (36,'temp','BJ',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (37,'temp','BJ',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (38,'temp','BJ',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (39,'temp','TJ',0)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (40,'temp','TJ',1)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (41,'temp','TJ',1)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (42,'temp','TJ',2)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (43,'temp','TJ',3)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (44,'temp','TJ',3)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (45,'temp','TJ',3)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (46,'temp','TJ',4)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (47,'temp','TJ',4)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (48,'temp','TJ',4)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (49,'temp','TJ',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (50,'temp','TJ',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (51,'temp','TJ',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (52,'temp','SH',0)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (53,'temp','SH',0)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (54,'temp','SH',0)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (55,'temp','SH',1)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (56,'temp','SH',1)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (57,'temp','SH',2)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (58,'temp','SH',2)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (59,'temp','SH',2)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (60,'temp','SH',2)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (61,'temp','SH',3)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (62,'temp','SH',3)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (63,'temp','SH',3)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (64,'temp','SH',3)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (65,'temp','SH',4)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (66,'temp','SH',4)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (67,'temp','SH',4)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (68,'temp','SH',4)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (69,'temp','SH',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (70,'temp','SH',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (71,'temp','SH',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (72,'temp','SH',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (73,'temp','SH',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (74,'temp','SH',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (75,'temp','SH',5)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (76,'temp','XZ',0)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (77,'temp','XZ',0)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (78,'temp','XZ',1)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (79,'temp','XZ',2)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (80,'temp','XZ',3)
INTO "JOHANN_PIVOT_TEST" (CUST_ID,CUST_NAME,PROVINCE_CODE,TIMES_PURCHASED) VALUES (81,'temp','XZ',5)
SELECT 1 FROM DUAL;
```